<html>
	<head>
		<link href="style.css" rel="stylesheet" type="text/css">
		<script
	  src="https://code.jquery.com/jquery-3.2.1.min.js"
	  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
	  crossorigin="anonymous"></script>
		<script>
			var Items = {
				ids: []
			};
			var Profiles = [];

			var tempItemData = {"agi":1112,"agistrint":1112,"appearances":{"0":[158279,""]},"armor":150,"critstrkrtng":543,"displayid":158279,"hastertng":351,"versatility":847,"mastrtng":847,"int":1112,"reqlevel":110,"sellprice":463289,"slotbak":16,"sta":1668,"str":1112,"name":"Cape of Mindless Fury"};
			var tempItemData2 = {"critstrkrtng":847,"hastertng":847,"mastrtng":847,"reqlevel":110,"sellprice":485043,"slotbak":12,"versatility":847,"name":"Unstable Arcanocrystal"};

			Array.prototype.getUnique = function() {
				return this.filter(function(value, index, self) { 
					return self.indexOf(value) === index;
				});
			}

			var Parse = {
				profiles: {
					init: function() {
						var string = document.querySelector('#paste').value;
						var array  = string.match(/^.*/gm);
						var tempProfile = {};

						var pushProfile = function() {
							tempProfile.stats = {crit: 0, haste: 0, mastery: 0, vers: 0};
							Profiles.push(tempProfile);
							tempProfile = {};
						}

						for(let i=0; i < array.length; i++) {
							if(!array[i]) {
								pushProfile();
								continue;
							}

							let mainMatch = array[i].match(/(.*?)\=(.*?)($|\,)(.*)/);
							if(!mainMatch) continue;

							let subMatches = mainMatch[4];
							if(subMatches) {
								let subArray = subMatches.split(',');
								tempProfile[mainMatch[1]] = {name: mainMatch[2]};

								for(let j=0; j < subArray.length; j++) {
									let subItem = subArray[j].match(/(.*)\=(.*)/)
									tempProfile[mainMatch[1]][subItem[1]] = subItem[2];
								}
							} else {
								tempProfile[mainMatch[1]] = mainMatch[2];
							}
						}
						pushProfile();
					},
					stats: function() {
						for(var i=0; i < Profiles.length; i++) {
							for (var key in Profiles[i]) {
								if(Profiles[i].hasOwnProperty(key)) {
									if(typeof Profiles[i][key] === "object" && Profiles[i][key].id) {
										let item = Items[Profiles[i][key].id];
										Profiles[i].stats.crit 		+= item.critstrkrtng || 0;
										Profiles[i].stats.haste 	+= item.hastertng || 0;
										Profiles[i].stats.mastery += item.mastrtng || 0;
										Profiles[i].stats.vers 		+= item.versatility || 0;
									}
								}
							}
						}
					}
				},
				items: function() {
					for(var i=0; i < Profiles.length; i++) {
						for (var key in Profiles[i]) {
							if(Profiles[i].hasOwnProperty(key)) {
								if(typeof Profiles[i][key] === "object" && Profiles[i][key].id) Items.ids.push(Profiles[i][key].id);
							}
						}
					}
					Items.ids = Items.ids.getUnique();
				}
			}

			function gatherItemData(callback) {
				var itemLoop = function(i) {
					if(!Items.ids[i]) {
						callback();
						return;
					}
					getItemData(Items.ids[i], function(stats) {
							Items[Items.ids[i]] = stats;
							itemLoop(i+1);
					});
				}
				itemLoop(0);
			}

			function getItemData(id, callback) {
				callback(tempItemData2);
				return; //Only returns test data. Remove when done
				if(id === undefined) return;
				var url = 'http://www.wowhead.com/item='+id;
				$.get("http://cors-anywhere.herokuapp.com/"+url, function(data) {
					var regex = new RegExp('\\_\\['+ id +'\\]\\=(\\{.*?\\}\\;)');
					var stats = JSON.parse(data.match(regex)[1].slice(0, -1));
					var name 	= stats.name_enus;
							stats = stats.jsonequip;
							stats.name = name;

					if(typeof callback === 'function') callback(stats);
				});
			}

			function generateTable() {
				var table = document.querySelector('#profile_list > tbody');
				for(let i=0; i < Profiles.length; i++) {
					let row = document.createElement('tr');
					let stats = Profiles[i].stats;
					for (var key in stats) {
						if(stats.hasOwnProperty(key)) {
							let div = document.createElement('td');
							div.innerText = stats[key];
							row.appendChild(div);
						}
					}
					let name = document.createElement('td');
					name.innerText = Profiles[i].mage;
					row.prepend(name);
					table.appendChild(row);
				}
			};

			function runParser() {
				Parse.profiles.init();
				Parse.items();
				gatherItemData(function() {
					Parse.profiles.stats();
					generateTable();
					console.log('Finished parsing profiles!');
				});
			}
		</script>
	</head>
	<body>
		<textarea id="paste" spellcheck=false style="margin: 0px; height: 800px; width: 1000px;">
mage="Syana_T20"_00001
specialization=fire
race=human
level=110
role=spell
position=back
talents=3022023
artifact=54:0:0:0:0:748:1:749:4:750:4:751:4:752:4:753:4:754:4:755:4:756:4:757:4:758:1:759:1:760:1:761:1:762:1:763:1:1340:1:1372:1:1533:4:1534:1:1535:1:1536:1:1640:1
firestarter_time=20
head=crown_of_the_arcane_tempest,id=147147,bonus_id=3563/1512
neck=string_of_extracted_incisors,id=147013,ilevel=930,enchant=mark_of_the_hidden_satyr
shoulders=shoulderpads_of_whispering_twilight,id=146997,bonus_id=3563/1512
back=drape_of_the_arcane_tempest,id=147145,ilevel=930,enchant=binding_of_intellect
chest=robes_of_the_arcane_tempest,id=147149,bonus_id=3563/1512
wrists=marquee_bindings_of_the_sun_king,id=132406,ilevel=940
hands=gloves_of_furtive_oppression,id=146988,bonus_id=3561/1492
waist=koralons_burning_touch,id=132454,ilevel=970
legs=leggings_of_the_arcane_tempest,id=147148,bonus_id=3563/1512
feet=emberscatter_treads,id=146986,bonus_id=3563/1512
finger1=band_of_rescinded_truths,id=147194,bonus_id=3563/1512,enchant=binding_of_versatility
finger2=seal_of_the_second_duumvirate,id=147195,bonus_id=3563/1522,enchant=binding_of_versatility
trinket1=tarnished_sentinel_medallion,id=147017,ilevel=930
trinket2=terror_from_below,id=147016,ilevel=930
main_hand=felomelorn,id=128820,gem_id=147089/147079/147089,relic_ilevel=930/940/930
off_hand=heart_of_the_phoenix,id=133959

mage="Syana_T20"_00002
specialization=fire
race=human
level=110
role=spell
position=back
talents=3022023
artifact=54:0:0:0:0:748:1:749:4:750:4:751:4:752:4:753:4:754:4:755:4:756:4:757:4:758:1:759:1:760:1:761:1:762:1:763:1:1340:1:1372:1:1533:4:1534:1:1535:1:1536:1:1640:1
firestarter_time=20
head=crown_of_the_arcane_tempest,id=147147,bonus_id=3563/1512
neck=string_of_extracted_incisors,id=147013,ilevel=930,enchant=mark_of_the_hidden_satyr
shoulders=shoulderpads_of_whispering_twilight,id=146997,bonus_id=3563/1512
back=drape_of_the_arcane_tempest,id=147145,ilevel=930,enchant=binding_of_intellect
chest=robes_of_the_arcane_tempest,id=147149,bonus_id=3563/1512
wrists=marquee_bindings_of_the_sun_king,id=132406,ilevel=940
hands=gloves_of_furtive_oppression,id=146988,bonus_id=3561/1492
waist=koralons_burning_touch,id=132454,ilevel=970
legs=leggings_of_the_arcane_tempest,id=147148,bonus_id=3563/1512
feet=emberscatter_treads,id=146986,bonus_id=3563/1512
finger1=scaled_band_of_servitude,id=147020,bonus_id=3563/1512,enchant=binding_of_versatility
finger2=seal_of_the_second_duumvirate,id=147195,bonus_id=3563/1522,enchant=binding_of_versatility
trinket1=tarnished_sentinel_medallion,id=147017,ilevel=930
trinket2=terror_from_below,id=147016,ilevel=930
main_hand=felomelorn,id=128820,gem_id=147089/147079/147089,relic_ilevel=930/940/930
off_hand=heart_of_the_phoenix,id=133959
		</textarea>
		<table id="profile_list" class="table table-bordered">
			<tbody>
				<tr>
					<th>Profile</th>
					<th>Crit</th> 
					<th>Haste</th>
					<th>Mastery</th>
					<th>Versatility</th>
		  </tr>
		  </tbody>
		</table>
	</body>
</html>